{% extends "base.html" %}

{% block extra_head %}
<!-- Th√™m CSS c·ªßa Choices.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<style>
    /* Custom styles cho Choices.js */
    .choices {
        min-width: 250px;
    }

    .choices__inner {
        min-height: 38px;
        padding: 4px 8px;
        background-color: #fff;
        border: 1px solid #ced4da;
    }

    .choices__list--dropdown {
        z-index: 1000;
    }

    .choices__list--dropdown .choices__item--selectable {
        padding: 6px 12px;
    }

    .choices__list--dropdown .choices__item--manager {
        font-weight: bold;
        color: #2c3e50;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        padding-top: 10px;
    }

    .choices__list--dropdown .choices__item--user {
        padding-left: 2.5rem !important;
    }

    /* Card styles */
    .card {
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .rounded-circle {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">B√°o c√°o th·ªëng k√™</h2>
        
        {% if user.role == 'admin' or user.role == 'manager' %}
        <form method="GET" action="{{ url_for('report') }}" class="d-flex align-items-center gap-3">
            <div class="form-group mb-0">
                <select id="user_select" name="search_user" placeholder="Ch·ªçn nh√¢n vi√™n...">
                    {% if user.role == 'admin' %}
                        <option value="">üîç T·∫•t c·∫£ nh√¢n vi√™n</option>
                        {% for user_item in users %}
                            {% if user_item.role == 'manager' %}
                                {# Th√™m option cho manager #}
                                <option value="{{ user_item.username }}"
                                        {% if search_user == user_item.username %} selected {% endif %}>
                                    üë• {{ user_item.username }} (Qu·∫£n l√Ω)
                                </option>
                                {# Hi·ªÉn th·ªã nh√¢n vi√™n c·ªßa manager #}
                                {% for sub_user in users if sub_user.manager_username == user_item.username %}
                                    <option value="{{ sub_user.username }}"
                                            {% if search_user == sub_user.username %} selected {% endif %}>
                                        ‚îú‚îÄ üë§ {{ sub_user.username }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {# Hi·ªÉn th·ªã cho manager #}
                        <option value="{{ user.username }}">üë• {{ user.username }}</option>
                        {% for user_item in users %}
                            {% if user_item.manager_username == user.username %}
                                <option value="{{ user_item.username }}"
                                        {% if search_user == user_item.username %} selected {% endif %}>
                                    ‚îú‚îÄ üë§ {{ user_item.username }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary shadow-sm">
                <i class="fas fa-filter me-2"></i>L·ªçc b√°o c√°o
            </button>
        </form>
        {% endif %}
    </div>
    <!-- Th·ªëng k√™ s·ªë li·ªáu -->
    <div class="row g-4 mb-4">
        <!-- Card T·ªïng ti·ªÅn -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">T·ªïng ti·ªÅn giao thu</h6>
                            <h4 class="mb-0">{{ '{:,.0f}'.format(total_money) }} VNƒê</h4>
                        </div>
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="fas fa-money-bill-wave text-primary fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Ti·ªÅn ƒë√£ thu -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">S·ªë ti·ªÅn ƒë√£ thu</h6>
                            <h4 class="mb-0 text-success">{{ '{:,.0f}'.format(total_paid_money) }} VNƒê</h4>
                        </div>
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Ti·ªÅn ch∆∞a thu -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">S·ªë ti·ªÅn ch∆∞a thu</h6>
                            <h4 class="mb-0 text-danger">{{ '{:,.0f}'.format(total_unpaid_money) }} VNƒê</h4>
                        </div>
                        <div class="rounded-circle bg-danger bg-opacity-10 p-3">
                            <i class="fas fa-clock text-danger fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card T·ª∑ l·ªá thu ti·ªÅn -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">T·ª∑ l·ªá thu ti·ªÅn</h6>
                            <h4 class="mb-0 text-info">
                                {{ '{:.1f}'.format(total_paid_money / total_money * 100 if total_money > 0 else 0) }}%
                            </h4>
                        </div>
                        <div class="rounded-circle bg-info bg-opacity-10 p-3">
                            <i class="fas fa-percentage text-info fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th·ªëng k√™ h√≥a ƒë∆°n -->
    <div class="row g-4 mb-4">
        <!-- Card T·ªïng h√≥a ƒë∆°n -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">T·ªïng s·ªë h√≥a ƒë∆°n</h6>
                            <h4 class="mb-0">{{ total_invoices }}</h4>
                        </div>
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="fas fa-file-invoice text-primary fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card H√≥a ƒë∆°n ƒë√£ thu -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">H√≥a ƒë∆°n ƒë√£ thu</h6>
                            <h4 class="mb-0 text-success">{{ total_paid_invoices }}</h4>
                        </div>
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="fas fa-file-invoice-dollar text-success fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card H√≥a ƒë∆°n ch∆∞a thu -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">H√≥a ƒë∆°n ch∆∞a thu</h6>
                            <h4 class="mb-0 text-danger">{{ total_unpaid_invoices }}</h4>
                        </div>
                        <div class="rounded-circle bg-danger bg-opacity-10 p-3">
                            <i class="fas fa-file-excel text-danger fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card T·ª∑ l·ªá thu h√≥a ƒë∆°n -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">T·ª∑ l·ªá thu h√≥a ƒë∆°n</h6>
                            <h4 class="mb-0 text-info">
                                {{ '{:.1f}'.format(total_paid_invoices / total_invoices * 100 if total_invoices > 0 else 0) }}%
                            </h4>
                        </div>
                        <div class="rounded-circle bg-info bg-opacity-10 p-3">
                            <i class="fas fa-chart-pie text-info fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="row g-4">
        <!-- Bi·ªÉu ƒë·ªì c·ªôt th·ªëng k√™ theo ng√†y -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Th·ªëng k√™ theo ng√†y
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì tr√≤n th·ªëng k√™ theo m√£ l·ªô -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>
                        T·ª∑ l·ªá thu ti·ªÅn theo m√£ l·ªô
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<!-- Th√™m Choices.js -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- Kh·ªüi t·∫°o Choices -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = new Choices('#user_select', {
        searchEnabled: true,
        searchPlaceholderValue: 'T√¨m ki·∫øm nh√¢n vi√™n...',
        placeholder: true,
        placeholderValue: 'üîç Ch·ªçn nh√¢n vi√™n...',
        itemSelectText: '',
        classNames: {
            containerOuter: 'choices shadow-sm',
            input: 'form-control',
            inputCloned: 'form-control-sm',
            listDropdown: 'dropdown-menu',
            itemChoice: 'dropdown-item'
        },
        callbackOnInit: function() {
            // T√πy ch·ªânh style cho optgroup
            const optgroups = document.querySelectorAll('.choices__group');
            optgroups.forEach(group => {
                group.classList.add('choices__item--manager');
            });

            // T√πy ch·ªânh style cho options
            const options = document.querySelectorAll('.choices__item--choice');
            options.forEach(option => {
                if (!option.closest('.choices__group')) {
                    option.classList.add('choices__item--user');
                }
            });
        }
    });
});
</script>
{% endblock %}



<!-- Chart.js v√† c√°c plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì -->
<!-- Chart.js v√† c√°c plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì -->
<script>
    Chart.register(ChartDataLabels);

    // Parse d·ªØ li·ªáu JSON m·ªôt c√°ch an to√†n
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
    const pieChartData = JSON.parse('{{ pie_chart_data | tojson | safe }}');

    document.addEventListener('DOMContentLoaded', function() {
        // Bi·ªÉu ƒë·ªì c·ªôt theo ng√†y
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: chartData.dates,
                datasets: [{
                    label: 'S·ªë ti·ªÅn ƒë√£ thu (VNƒê)',
                    data: chartData.amounts,
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    borderColor: 'rgb(40, 167, 69)',
                    borderWidth: 2,
                    borderRadius: 5,
                    barThickness: 20
                }, {
                    label: 'S·ªë h√≥a ƒë∆°n',
                    data: chartData.counts,
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderColor: 'rgb(0, 123, 255)',
                    borderWidth: 2,
                    borderRadius: 5,
                    barThickness: 20,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' VNƒê';
                            }
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    datalabels: {
                        display: false
                    }
                }
            }
        });

        // Bi·ªÉu ƒë·ªì tr√≤n theo m√£ l·ªô
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: pieChartData.labels,
                datasets: [{
                    data: pieChartData.paid_percentages,
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(111, 66, 193, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold'
                        },
                        formatter: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        });
    });
</script>

<!-- Select2 initialization -->
<script>
$(document).ready(function() {
    $('.form-select-tree').select2({
        templateResult: formatUser,
        templateSelection: formatUserSelection,
        escapeMarkup: function(m) { return m; }
    });
});

function formatUser(user) {
    if (!user.id) return user.text;
    
    var $user = $(user.element);
    var role = $user.data('role');
    var manager = $user.data('manager');
    
    if (role === 'manager') {
        return $('<div class="select2-results__option--manager">' + user.text + '</div>');
    } else {
        return $('<div class="select2-results__option--user">' + user.text + '</div>');
    }
}

function formatUserSelection(user) {
    if (!user.id) return user.text;
    return user.text;
}
</script>
{% endblock %}